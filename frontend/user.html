<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”¨æˆ·ä¸­å¿ƒ - æ™ºèƒ½é‡‘èæ•°æ®åˆ†æåŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/style2.css">
</head>
<body class="user-page">
    <div class="app-container" style="max-width:960px;margin:40px auto;">
        <header class="header">
            <div class="header-content">
                <h1 class="app-title">ğŸ‘¤ ç”¨æˆ·ä¸­å¿ƒ</h1>
                <div class="header-actions">
                    <a href="index.html" class="btn btn-secondary">è¿”å›èŠå¤©</a>
                    <a href="settings.html" class="btn btn-secondary">è®¾ç½®</a>
                </div>
            </div>
        </header>

        <main class="chat-container" style="padding: 1rem;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
                <div class="card" style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;">
                    <h2 style="margin:0 0 10px 0;">è´¦æˆ·æ¦‚è§ˆ</h2>
                    <div id="profileBox" style="color:#4a5568;line-height:1.8;">
                        åŠ è½½ä¸­...
                    </div>
                </div>
                <div class="card" style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;">
                    <h2 style="margin:0 0 10px 0;">å¿«æ·å…¥å£</h2>
                    <div style="display:flex;gap:.5rem;flex-wrap:wrap;">
                        <a href="settings.html" class="btn btn-secondary">è´¦æˆ·ä¸å®‰å…¨</a>
                        <a href="#userModelsSection" class="btn btn-secondary">æˆ‘çš„è‡ªå®šä¹‰æ¨¡å‹</a>
                        <a href="#tushareSection" class="btn btn-secondary">æˆ‘çš„ Tushare Token</a>
                    </div>
                </div>
            </div>

            <div id="userModelsSection" class="card models-card" style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-top:16px;">
                <div style="display:flex;justify-content:space-between;align-items:center;gap:8px; margin-bottom:8px;">
                    <h2 style="margin:0;">æˆ‘çš„è‡ªå®šä¹‰æ¨¡å‹</h2>
                    <div>
                        <button id="btnAddModel" class="btn" style="background:#2563eb;color:#fff;">æ–°å¢æ¨¡å‹</button>
                    </div>
                </div>
                <div id="modelsList" style="overflow:auto;">
                    <div style="color:#718096;">åŠ è½½ä¸­...</div>
                </div>
                <div id="modelFormWrap" style="display:none;margin-top:12px;border-top:1px dashed #e2e8f0;padding-top:12px;">
                    <h3 id="formTitle" style="margin:0 0 8px 0;">æ–°å¢æ¨¡å‹</h3>
                    <div style="display:grid;grid-template-columns:repeat(2, minmax(0, 1fr));gap:12px;">
                        <label>æ˜¾ç¤ºåç§°<label style="color:#ef4444;">*</label>
                            <input id="fm_label" class="input" placeholder="å¦‚ï¼šæˆ‘çš„DeepSeek" />
                        </label>
                        <label>æ¨¡å‹å<label style="color:#ef4444;">*</label>
                            <input id="fm_model" class="input" placeholder="å¦‚ï¼šdeepseek-chat / glm-4.5" />
                        </label>
                        <label>Base URL
                            <input id="fm_base_url" class="input" placeholder="å¦‚ï¼šhttps://api.deepseek.com/v1ï¼ˆå¯ç•™ç©ºï¼‰" />
                        </label>
                        <label>API Key<label style="color:#ef4444;">*</label>
                            <input id="fm_api_key" class="input" placeholder="è¯·è¾“å…¥APIå¯†é’¥" />
                        </label>
                        <label>Temperature
                            <input id="fm_temperature" class="input" type="number" step="0.1" min="0" max="2" value="0.2" />
                        </label>
                        <label>Timeout (s)
                            <input id="fm_timeout" class="input" type="number" step="1" min="1" value="60" />
                        </label>
                    </div>
                    <label style="display:block;margin-top:10px;">ç³»ç»Ÿæç¤ºè¯
                        <textarea id="fm_system_prompt" class="input" style="height:100px;" placeholder="å¯é€‰ï¼Œæ”¯æŒæ—¶é—´å ä½ç¬¦ï¼ˆè§READMEï¼‰"></textarea>
                    </label>
                    <label style="display:flex;align-items:center;gap:8px;margin-top:10px;">
                        <input id="fm_enabled" type="checkbox" checked /> å¯ç”¨
                    </label>
                    <div style="margin-top:12px;display:flex;gap:8px;">
                        <button id="btnSaveModel" class="btn" style="background:#10b981;color:#fff;">ä¿å­˜</button>
                        <button id="btnCancelModel" class="btn btn-secondary">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>

            <div id="tushareSection" class="card" style="background:#fff;border:1px solid #e2e8f0;border-radius:8px;padding:16px;margin-top:16px;">
                <h2 style="margin:0 0 10px 0;">æˆ‘çš„ Tushare Token</h2>
                <div style="display:flex;gap:.5rem;align-items:center;">
                    <input id="ut_input" type="password" class="input" placeholder="è¾“å…¥/æ›´æ–°ä½ çš„ Tushare Token" style="flex:1;" />
                    <button id="ut_save" class="btn" style="background:#10b981;color:#fff;">ä¿å­˜</button>
                    <button id="ut_clear" class="btn btn-secondary">æ¸…é™¤</button>
                </div>
                <div id="ut_status" style="margin-top:.5rem;color:#64748b;font-size:.9rem;">çŠ¶æ€ï¼šåŠ è½½ä¸­...</div>
            </div>
        </main>
    </div>

    <script src="js/config.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/user-models.js"></script>
    <script>
    (function(){
        const token = (window.Auth && Auth.getToken && Auth.getToken()) || '';
        if (!token) { alert('è¯·å…ˆç™»å½•'); try { window.location.href = 'login.html'; } catch{} return; }
        const box = document.getElementById('profileBox');
        async function loadCredits(){
            try {
                if (!window.configManager || !window.configManager.isLoaded) {
                    await window.configManager.loadConfig();
                }
                const url = window.configManager.getFullApiUrl('/api/auth/credits');
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json().catch(()=>({}));
                const credits = (data && data.credits) || 0;
                const username = (window.Auth && Auth.getUsername && Auth.getUsername()) || '';
                box.innerHTML = `ç”¨æˆ·åï¼š<strong>${username}</strong><br>ç§¯åˆ†ä½™é¢ï¼š<strong>${credits}</strong>`;
            } catch(e) {
                box.textContent = 'åŠ è½½å¤±è´¥ï¼š' + (e.message||e);
            }
        }
        loadCredits();
        // åŠ è½½ç”¨æˆ·è‡ªå®šä¹‰æ¨¡å‹ç®¡ç†æ¨¡å—
        try { window.UserModels && window.UserModels.init && window.UserModels.init(); } catch(e) { console.warn('UserModels init failed', e); }

        // --- Tushare Token åŒº ---
        const utStatus = document.getElementById('ut_status');
        async function refreshUTStatus(){
            try{
                if (!window.configManager || !window.configManager.isLoaded) {
                    await window.configManager.loadConfig();
                }
                const url = window.configManager.getFullApiUrl('/api/user/tushare_token');
                const res = await fetch(url, { headers: { 'Authorization': `Bearer ${token}` } });
                const data = await res.json().catch(()=>({}));
                if (res.ok && data && data.success){
                    utStatus.textContent = 'çŠ¶æ€ï¼š' + (data.is_set ? 'å·²è®¾ç½®' : 'æœªè®¾ç½®');
                } else {
                    utStatus.textContent = 'çŠ¶æ€ï¼šæŸ¥è¯¢å¤±è´¥';
                }
            }catch(e){ utStatus.textContent = 'çŠ¶æ€ï¼šæŸ¥è¯¢å¤±è´¥'; }
        }
        refreshUTStatus();

        async function saveUT(clear){
            const input = document.getElementById('ut_input');
            const val = (input.value||'').trim();
            if (!clear && !val){ utStatus.style.color = '#e53e3e'; utStatus.textContent = 'è¯·è¾“å…¥æœ‰æ•ˆçš„ Token'; return; }
            try{
                const url = window.configManager.getFullApiUrl('/api/user/tushare_token');
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                    body: JSON.stringify(clear ? { clear: true } : { token: val })
                });
                const data = await res.json().catch(()=>({}));
                if (!res.ok || !data.success) throw new Error(data.detail || 'ä¿å­˜å¤±è´¥');
                utStatus.style.color = '#2f855a';
                utStatus.textContent = clear ? 'å·²æ¸…é™¤' : 'ä¿å­˜æˆåŠŸ';
                input.value = '';
                // ä¿å­˜æˆåŠŸåï¼Œæ— éœ€åˆ·æ–°å…¨å±€é…ç½®ï¼›ä¼šè¯é‡è¿æ—¶å°†è‡ªåŠ¨å¸¦å…¥
            }catch(e){ utStatus.style.color = '#e53e3e'; utStatus.textContent = 'ä¿å­˜å¤±è´¥ï¼š' + (e.message||e); }
            finally{ setTimeout(()=>{ utStatus.style.color = '#64748b'; refreshUTStatus(); }, 800); }
        }
        document.getElementById('ut_save').addEventListener('click', ()=>saveUT(false));
        document.getElementById('ut_clear').addEventListener('click', ()=>saveUT(true));
    })();
    </script>
</body>
</html>



