<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½é‡‘èæ•°æ®åˆ†æåŠ©æ‰‹</title>
    <link rel="stylesheet" href="css/style.css">
    <!-- Include marked.js for markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- Include html2canvas for screenshots -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <!-- Mermaid for rendering diagrams (flowchart/sequence/pie/etc.) -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- Chart.js for bar charts, line charts, etc. -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Chart.js Financial (Candlestick/ohlc) plugin -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@3"></script>
    <!-- Timeseries date adapter for Chart.js (parse YYYY-MM-DD) -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
    <!-- ECharts for richer chart support -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
    <script>
      // Initialize Mermaid; do not auto-run on page load, we control rendering per message
      try { mermaid.initialize({ startOnLoad: false }); } catch (e) { console.warn('Mermaid init failed:', e); }
    </script>
</head>
<body class="index-page">
    <div class="app-container">
        <!-- Left sidebar - ChatGPT/Apple Style -->
        <aside class="sidebar" id="historySidebar">
            <!-- é¡¶éƒ¨ï¼šæ–°å»ºå¯¹è¯æŒ‰é’® -->
            <div class="sidebar-header">
                <div class="sidebar-controls">
                    <div class="sidebar-logo">ğŸ’¼ é‡‘èåŠ©æ‰‹</div>
                    <button id="sidebarToggleBtn" class="sidebar-toggle-btn" title="å…³é—­ä¾§è¾¹æ ">
                        <span style="font-size: 1.2rem;">â˜°</span>
                    </button>
                </div>
                <button id="startNewChatBtn" class="new-chat-btn">
                    <span class="icon">â•</span>
                    <span>æ–°å»ºå¯¹è¯</span>
                </button>
            </div>

            <!-- å†å²è®°å½•åˆ—è¡¨ -->
            <div class="sidebar-section-title">å†å²å¯¹è¯</div>
            <div class="sidebar-content" id="threadsList"></div>

            <!-- åº•éƒ¨ï¼šä¸ªäººä¸­å¿ƒ -->
            <div class="sidebar-footer">
                <!-- æœªç™»å½•çŠ¶æ€ -->
                <a href="login.html" id="loginLink" class="user-profile" style="display:none">
                    <div class="user-profile-avatar">ğŸ‘¤</div>
                    <div class="user-profile-info">
                        <div class="user-profile-name">ç™»å½•</div>
                        <div class="user-profile-email">è®¿é—®æ›´å¤šåŠŸèƒ½</div>
                    </div>
                </a>

                <!-- å·²ç™»å½•çŠ¶æ€ -->
                <div id="userProfile" class="user-profile" style="display:none">
                    <div class="user-profile-avatar" id="profileAvatar">ğŸ‘¤</div>
                    <div class="user-profile-info">
                        <div class="user-profile-name" id="profileName">ç”¨æˆ·</div>
                        <div class="user-profile-email" id="profileEmail">user@example.com</div>
                    </div>
                    <!-- ä¸ªäººä¸­å¿ƒä¸‹æ‹‰èœå• -->
                    <div class="user-profile-menu" id="userProfileMenu">
                        <div class="user-profile-menu-item" id="menuUserCenter">
                            <span>ğŸ‘¤</span>
                            <span>ç”¨æˆ·ä¸­å¿ƒ</span>
                        </div>
                        <div class="user-profile-menu-item" id="menuSettings">
                            <span>âš™ï¸</span>
                            <span>è®¾ç½®</span>
                        </div>
                        <div class="user-profile-menu-item" id="menuAbout">
                            <span>â„¹ï¸</span>
                            <span>å…³äºæˆ‘ä»¬</span>
                        </div>
                        <div class="user-profile-menu-item danger" id="menuLogout">
                            <span>ğŸšª</span>
                            <span>é€€å‡ºç™»å½•</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Top navigation bar - Simplified -->
        <header class="header">
            <!-- ç§»åŠ¨ç«¯èœå•æŒ‰é’® -->
            <button id="mobileMenuBtn" class="mobile-menu-btn">
                <span class="icon">â˜°</span>
            </button>

            <div class="header-content">
                <!-- å·¦ä¾§ï¼šæ¨¡å‹é€‰æ‹© -->
                <div class="header-left">
                    <div class="model-switcher">
                        <button id="modelDropdownBtn" class="btn btn-secondary">æ¨¡å‹ï¼šé»˜è®¤ â–¾</button>
                        <div id="modelDropdown" class="dropdown-menu" style="display:none"></div>
                    </div>
                </div>

                <!-- å³ä¾§ï¼šåˆ†äº«æŒ‰é’®å’Œè¿æ¥çŠ¶æ€ -->
                <div class="header-right">
                    <button id="shareChatBtn" class="btn btn-secondary">
                        <span>ğŸ”—</span>
                        <span>åˆ†äº«å¯¹è¯</span>
                    </button>
                    
                    <div class="status-indicator">
                        <span id="connectionStatus" class="status-dot offline"></span>
                        <span id="connectionText">ç¦»çº¿</span>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main chat area -->
        <main class="chat-container">
            <!-- Chat messages area -->
            <div class="chat-messages" id="chatMessages">
                <div class="welcome-message">
                    <div class="welcome-icon">ğŸ’¼</div>
                    <h2>æ¬¢è¿ä½¿ç”¨æ™ºèƒ½é‡‘èæ•°æ®åˆ†æåŠ©æ‰‹</h2>
                    <p>æˆ‘æ˜¯æ‚¨çš„ä¸“ä¸šé‡‘èæ•°æ®åˆ†æåŠ©æ‰‹ï¼ŒåŸºäºå…ˆè¿›çš„AIæŠ€æœ¯æ‰“é€ ã€‚åœ¨æ‚¨çš„ç§æœ‰å®‰å…¨ç¯å¢ƒä¸­éƒ¨ç½²ï¼Œç¡®ä¿æ•°æ®å®‰å…¨æ— æ³„éœ²é£é™©ã€‚æ‚¨å¯ä»¥é€‰æ‹©ä¸åŒçš„AIæ¨¡å‹ï¼ˆå¦‚ LLaMA æˆ– DeepSeekï¼‰ï¼Œç”¨è‡ªç„¶è¯­è¨€æŸ¥è¯¢é‡‘èæ•°æ®åº“ï¼Œå³æ—¶è·å¾—æ•°æ®æ´å¯Ÿï¼Œæ— éœ€ç¼–ç¨‹æŠ€èƒ½ã€‚æˆ‘çš„ç›®æ ‡æ˜¯è®©æ‚¨çš„é‡‘èåˆ†ææ›´å¿«é€Ÿã€æ›´ç²¾å‡†ã€æ›´ä¸“ä¸šã€‚</p>
                    <p>è¯·è¾“å…¥æ‚¨çš„é‡‘èé—®é¢˜æˆ–æ•°æ®æŸ¥è¯¢éœ€æ±‚å¼€å§‹å¯¹è¯ã€‚</p>
                <div class="quick-prompts">
                    <h3>ä¸ä¼šé—®ï¼Ÿè¯•è¯•è¿™äº›ç¤ºä¾‹é—®é¢˜</h3>
                    <div class="quick-prompt-list"></div>
                </div>
                </div>
            </div>

            <!-- Input area -->
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <textarea 
                        id="messageInput" 
                        placeholder="è¯·è¾“å…¥æ‚¨çš„é‡‘èé—®é¢˜æˆ–æ•°æ®æŸ¥è¯¢..." 
                        rows="1"
                        maxlength="2000"
                    ></textarea>
                    <div id="attachmentChips" class="attach-chips"></div>
                    <button id="uploadBtn" class="send-btn" title="ä¸Šä¼ æ–‡ä»¶">
                        <span>ğŸ“</span>
                    </button>
                    <input id="fileInput" type="file" style="display:none" multiple>
                    <button id="sendBtn" class="send-btn" disabled>
                        <span class="send-icon">ğŸ“¤</span>
                    </button>
                </div>
                <div class="input-hint">
                    æŒ‰ Enter å‘é€ï¼ŒShift + Enter æ¢è¡Œ | <span id="charCount">0</span>/2000
                </div>
            </div>
        </main>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</div>
    </div>

    <!-- JavaScript -->
    <script src="js/auth.js"></script>
    <script src="js/config.js"></script>
    <script src="js/ws.js"></script>
    <script src="js/chat/thinking-flow.js"></script>
    <script src="js/chat/message-actions.js"></script>
    <script src="js/chat/history.js"></script>
    <script src="js/chat/share-module.js"></script>
    <!-- New modular components -->
    <script src="js/chat/markdown-renderer.js"></script>
    <script src="js/chat/ui-controller.js"></script>
    <script src="js/chat/file-upload-manager.js"></script>
    <script src="js/chat/model-manager.js"></script>
    <script src="js/chat/message-manager.js"></script>
    <script src="js/chat.js"></script>
    <script>
    (function(){
        function refreshAuthUI(){
            const user = window.Auth && Auth.getUsername();
            const token = window.Auth && Auth.getToken();
            const loginLink = document.getElementById('loginLink');
            const userProfile = document.getElementById('userProfile');
            const profileName = document.getElementById('profileName');
            const profileEmail = document.getElementById('profileEmail');
            
            if (token && user) {
                // å·²ç™»å½•ï¼šæ˜¾ç¤ºç”¨æˆ·ä¿¡æ¯
                if (loginLink){ loginLink.style.display='none'; }
                if (userProfile){ userProfile.style.display='flex'; }
                if (profileName){ profileName.textContent = user; }
                if (profileEmail){ profileEmail.textContent = user; } // å¯ä»¥æ”¹ä¸ºå®é™…é‚®ç®±
            } else {
                // æœªç™»å½•ï¼šæ˜¾ç¤ºç™»å½•é“¾æ¥
                if (loginLink){ loginLink.style.display='flex'; }
                if (userProfile){ userProfile.style.display='none'; }
            }
        }

        document.addEventListener('DOMContentLoaded', function(){
            // ç”¨æˆ·ä¿¡æ¯èœå•äº¤äº’
            try {
                const userProfile = document.getElementById('userProfile');
                const menu = document.getElementById('userProfileMenu');
                const goUser = document.getElementById('menuUserCenter');
                const goSettings = document.getElementById('menuSettings');
                const goAbout = document.getElementById('menuAbout');
                const goLogout = document.getElementById('menuLogout');
                
                // ç‚¹å‡»ç”¨æˆ·å¤´åƒæ˜¾ç¤º/éšè—èœå•
                if (userProfile && menu){
                    userProfile.addEventListener('click', function(e){
                        e.stopPropagation();
                        menu.classList.toggle('show');
                    });
                    
                    // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­èœå•
                    document.addEventListener('click', function(){
                        menu.classList.remove('show');
                    });
                    
                    menu.addEventListener('click', function(e){
                        e.stopPropagation();
                    });
                }
                
                // èœå•é¡¹ç‚¹å‡»äº‹ä»¶
                if (goUser){ goUser.addEventListener('click', ()=>{ window.location.href = 'user.html'; }); }
                if (goSettings){ goSettings.addEventListener('click', ()=>{ window.location.href = 'settings.html'; }); }
                if (goAbout){ goAbout.addEventListener('click', ()=>{ window.location.href = 'about.html'; }); }
                if (goLogout){ 
                    goLogout.addEventListener('click', ()=>{ 
                        try { Auth.clear(); } catch{}; 
                        refreshAuthUI(); 
                        try { location.reload(); } catch{}; 
                    }); 
                }
                
                // ç§»åŠ¨ç«¯èœå•æŒ‰é’®
                const mobileMenuBtn = document.getElementById('mobileMenuBtn');
                const sidebar = document.getElementById('historySidebar');
                const appContainer = document.querySelector('.app-container');
                
                if (mobileMenuBtn && sidebar){
                    mobileMenuBtn.addEventListener('click', function(){
                        sidebar.classList.toggle('open');
                        appContainer.classList.toggle('sidebar-open');
                    });
                }
                
                // ç‚¹å‡»ä¾§è¾¹æ å¤–éƒ¨åŒºåŸŸå…³é—­ä¾§è¾¹æ ï¼ˆç§»åŠ¨ç«¯ï¼‰
                if (window.innerWidth <= 768) {
                    document.addEventListener('click', function(e) {
                        if (sidebar && sidebar.classList.contains('open')) {
                            if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                                sidebar.classList.remove('open');
                                appContainer.classList.remove('sidebar-open');
                            }
                        }
                    });
                }
                
                // ä¾§è¾¹æ å…³é—­æŒ‰é’®
                const sidebarToggleBtn = document.getElementById('sidebarToggleBtn');
                if (sidebarToggleBtn && sidebar){
                    sidebarToggleBtn.addEventListener('click', function(){
                        // æ¡Œé¢ç«¯ï¼šåˆ‡æ¢ä¾§è¾¹æ æ˜¾ç¤º
                        if (window.innerWidth > 768) {
                            sidebar.style.transform = 'translateX(-100%)';
                            appContainer.style.paddingLeft = '0';
                            
                            // åœ¨headerä¸Šæ·»åŠ ä¸€ä¸ªæ˜¾ç¤ºä¾§è¾¹æ çš„æŒ‰é’®
                            if (!document.getElementById('showSidebarBtn')) {
                                const showBtn = document.createElement('button');
                                showBtn.id = 'showSidebarBtn';
                                showBtn.className = 'mobile-menu-btn';
                                showBtn.style.display = 'flex';
                                showBtn.innerHTML = '<span class="icon">â˜°</span>';
                                showBtn.onclick = function() {
                                    sidebar.style.transform = 'translateX(0)';
                                    appContainer.style.paddingLeft = '280px';
                                    showBtn.remove();
                                };
                                const header = document.querySelector('.header');
                                if (header) {
                                    header.insertBefore(showBtn, header.firstChild);
                                }
                            }
                        } else {
                            // ç§»åŠ¨ç«¯ï¼šå…³é—­ä¾§è¾¹æ 
                            sidebar.classList.remove('open');
                            appContainer.classList.remove('sidebar-open');
                        }
                    });
                }
            } catch(e) {
                console.error('UI initialization error:', e);
            }
            
            refreshAuthUI();
        });
    })();
    </script>
</body>
</html>
